<script>
  function addUnit(address, unit) {
    if (typeof unit != "undefined" && unit.length > 0) {
      let addressTokens = address.split(',');
      let street = addressTokens[0];
      street = street + " " + unit;
      addressTokens.shift();
      let addressEnding = addressTokens.join(',');
      address = street + ',' + addressEnding;
    }
    console.log('Formed address ' + address + ' from address and unit');
    return address;
  }

  function parseResult(result, setCondo) {
    try {
      let estimatedValue = result.EstimatedValue;
      let estimatedMinValue = result.EstimatedMinValue;
      let estimatedMaxValue = result.EstimatedMaxValue;
      let confidenceScore = result.ConfidenceScore;
      let storiesCount = result.StoriesCount;
      let bedroomsCount = result.BedroomsCount;
      let bathroomsCount = result.BathroomsCount;
      let areaBuilding = result.AreaBuilding;
      let areaLotAcres = result.AreaLotAcres;
      let yearBuilt = result.YearBuilt;
      let pool = result.Pool;
      let poolArea = result.PoolArea;
      let propertyUseCode = result.PropertyUseCode;
      let isCondo = result.IsCondo;

      console.log('Got estimate of ' + estimatedValue);
      console.log('Got bedrooms ' + bedroomsCount);
      console.log('Got baths ' + bathroomsCount);
      console.log('Got year built ' + yearBuilt);
      console.log('Got pool ' + pool);
      console.log('Got property use code' + propertyUseCode);
      console.log('This is a condo: ' + isCondo);

      //      if (estimatedValue === "$0" || estimatedValue === "$NaN" || typeof estimatedValue === "undefined") {
      if (typeof isCondo === "undefined") {
        console.log('Got this for isCondo ' + isCondo);
        throw 'Unable to pull value estimate';
      } else {

        // COULD TURN THIS INTO A LOOPING FUNCTION (LOOP THROUGH IDs)
        let selectBeds = document.getElementById('select-beds');
        selectBeds.value = bedroomsCount;
        selectBeds.dispatchEvent(new Event('change'));

        let selectBaths = document.getElementById('select-baths');
        selectBaths.value = bathroomsCount;
        selectBaths.dispatchEvent(new Event('change'));

        let selectStories = document.getElementById('select-stories');
        selectStories.value = storiesCount;
        selectStories.dispatchEvent(new Event('change'));

        let selectYear = document.getElementById('select-year-built');
        selectYear.value = yearBuilt;
        selectYear.dispatchEvent(new Event('change'));

        let selectPool = document.getElementById('select-pool');
        if (pool != "Not Provided" && pool != "Unknown") {
          console.log('Should be setting pool to Yes');
          selectPool.value = 'Yes';
        } else {
          selectPool.value = 'No';
        }
        selectPool.dispatchEvent(new Event('change'));

        console.log('Got isCondo ' + isCondo + ' from pullPropertyInfo');
        if (setCondo && (isCondo == "True" || isCondo == "true" || isCondo)) {
          console.log('Is a condo, so should be asking for unit');
          document.getElementById('is-condo').setAttribute('is-condo', 'true');
          $("#relationship-page").hide();
          $("#market-analysis-loader").hide();
          $("#condo-unit-page").show();
          $("#relationship-back-btn-div").show();
          $("#stories-select-div").hide();
        } else {
          console.log('IN THE ELSE?');
        }
      }
    } catch (error) {
      console.log(error);
    }
  }

  function pullPropertyInfo(url, address, setCondo) {
    let requestUrl = url + address;
    $.ajax({
      url: requestUrl,
      method: 'GET',
    }).done(function (result) {
      return parseResult(result, setCondo);
    }).fail(function (err) {
      console.log('Unabled to pull home value estimate');
      console.log(err);
    });
  }

  let queryString = window.location.search;
  console.log('Got this queryString ' + queryString)
  let params = new URLSearchParams(queryString);
  console.log('Got these params ' + params)
  let address = params.get("address"); // is the number 123
  console.log('Pulled address from queryString: ' + address);

  let addressDisplay = document.getElementById("address-display");
  let addressDisplay2 = document.getElementById("address-display-2");
  addressDisplay.innerHTML = address;
  addressDisplay2.innerHTML = address;

  let apiUrl = "https://y9lns0og13.execute-api.us-east-1.amazonaws.com/prod/value/";

  $(document).ready(function () {
    console.log('Initially assuming is-condo is....');
    console.log(document.getElementById('is-condo').getAttribute('is-condo'));
    pullPropertyInfo(apiUrl, address, true);
  });

  document.getElementById("relationship-back-btn").addEventListener('click', (event) => {
    let addressDisplay = document.getElementById("address-display");
    let addressDisplay2 = document.getElementById("address-display-2");
    addressDisplay.innerHTML = address;
    addressDisplay2.innerHTML = address;
    document.getElementById("unit").value = "";
  });

  document.getElementById("no-unit-btn").addEventListener('click', (event) => {
    pullPropertyInfo(apiUrl, address, false);
  });

  document.getElementById("unit-submit-btn").addEventListener('click', (event) => {
    let unit = document.getElementById("unit-input").value.trim();
    let unitAddress = addUnit(address, unit);
    document.getElementById("unit").value = unit;
    document.getElementById("address-display").innerHTML = unitAddress;
    document.getElementById("address-display-2").innerHTML = unitAddress;
    pullPropertyInfo(apiUrl, unitAddress, false);
  });   
</script>



<script type="text/javascript">
  document.getElementById("contact-show-report-btn").onclick = function () {
    console.log('Submitting address');
    // Redirect to this URL with the value of the form fields appended to the end of the URL
    let nextPagePath = '/value-report'; // '/value-report.html'; // might have to change to this
    let fullName = document.getElementById("name-input").value.trim();
    let phone = document.getElementById("phone-input").value.trim();
    console.log('Here phone length ' + phone.length);
    let queryString;
    if (typeof fullName == "undefined" || fullName.length <= 3 || typeof phone == "undefined" || phone.length < 10) {
      console.log('Invalid input');
      return;
    }

    queryString = _generateFormResponseURLSuffix(fullName, phone);
    let currentUrl = window.location.href;
    let prefix = currentUrl.split(':')[0];
    let nextPageUrl;
    if (prefix === "https") {
      nextPageUrl = _generateWebURL("https", currentUrl, nextPagePath, queryString);
    } else if (prefix === "http") {
      nextPageUrl = _generateWebURL("http", currentUrl, nextPagePath, queryString);
    } else {
      nextPageUrl = _generateLocalURL(currentUrl, nextPagePath, queryString);
    }
    console.log('Here nextPageUrl: ' + nextPageUrl);
    location.href = nextPageUrl;
  };

  function _generateWebURL(prefix, currentUrl, nextPagePath, queryString) {
    /* NOTE that this function assumes we are going from some base URL to a specified path 
          (e.g., homevalues.com to homevalues.com/values/details */
    let urlBase = currentUrl.split(prefix + '://')[1];
    let domain = urlBase.split('/')[0];
    let nextPageURL = prefix + '://' + domain + nextPagePath + queryString; // may not need to add the prefix on web (may be automatic)
    return nextPageURL;
  }
  function _generateLocalURL(currentUrl, nextPagePath, queryString) {
    /* NOTE that this function assumes we are navigating from e.g., index.html to a folder in the same directory
          (e.g., /my/computer/index.html to /my/computer/values/details.html */
    let currentUrlTokens = currentUrl.split('/');
    currentUrlTokens.pop(); // remove the current filename (e.g., index.html)
    let currentUrlBase = currentUrlTokens.join('/'); // recreate the path without the filename
    let nextPageURL = currentUrlBase + nextPagePath + queryString;
    return nextPageURL;
  }
  function _generateFormResponseURLSuffix(fullName, phone) {
    // Get all form values and convert them to URL-safe key-value pairs
    // let string = '?address=' + encodeURIComponent(document.getElementById("address").value.trim())
    console.log('Trying to generate query string (fromResponseURLSuffix) from address-display');
    let addressValue = document.getElementById("address-display").innerHTML.trim();
    console.log('Got this from address-display: ' + addressValue);
    let string = '?address=' + encodeURIComponent(addressValue) + '&name=' + fullName + '&phone=' + phone;
    return string;
  }
</script>

<script data-info="hacks-body">
  // on DOM ready
  document.addEventListener("DOMContentLoaded", function () {
    //set your formatting options
    //Version 1 output = "Sat, Dec 25, 2019"
    const dateVersion1 = {
      weekday: "short",
      year: "numeric",
      month: "short",
      day: "2-digit"
    }

    //Version 2 output = "12/25/19"
    const dateVersion2 = {
      year: "2-digit",
      month: "2-digit",
      day: "2-digit"
    }

    // Update the text content of our text elements with the formatted date 
    document.querySelector('.hack22-date-version1').textContent = new Date().toLocaleDateString('en-US', dateVersion1);
    document.querySelector('.hack22-date-version2').textContent = new Date().toLocaleDateString('en-US', dateVersion2);
  });
</script>